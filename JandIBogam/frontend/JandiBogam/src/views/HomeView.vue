<template>
  <div class="min-h-screen bg-brand-lightbg">
    <!-- Main Content - í—¤ë” ë„ˆë¹„ì— ë§ì¶¤ -->
    <main class="w-full max-w-[1024px] px-8 mx-auto py-10">
      <!-- Family Members Section -->
      <section class="bg-[#C7D7CB] bg-opacity-50 rounded-2xl p-6 mb-6 shadow-md">
        <div class="flex justify-between items-center mb-5">
          <h2 class="text-lg font-bold text-gray-800">ê°€ì¡± êµ¬ì„±ì›</h2>
        </div>
        <div
          class="flex flex-row gap-x-8 pb-2 overflow-x-auto overflow-y-hidden scroll-smooth whitespace-nowrap"
        >
          <div
            v-for="(member, index) in allMembers"
            :key="member.id"
            class="flex flex-col items-center cursor-pointer transition-all duration-200 hover:scale-105 min-w-[120px] max-w-[120px]"
            @click="goToMealList(member.id)"
          >
            <div
              class="w-24 h-24 bg-white rounded-full flex items-center justify-center mb-2 shadow-family-profile"
            >
              <div class="w-20 h-20 rounded-full bg-amber-300 flex items-center justify-center">
                <span class="emoji-large">{{ getMemberEmoji(index) }}</span>
              </div>
            </div>
            <h3 class="text-base text-gray-800 font-medium">{{ member.name }}</h3>
            <p class="text-xs text-gray-600">{{ member.groupName || '' }}</p>
          </div>
          <!-- Add Member Button(ë”ë³´ê¸°) -->
          <div
            class="flex flex-col items-center cursor-pointer transition-all duration-200 hover:scale-105 min-w-[120px] max-w-[120px]"
            @click="goToMyPage"
          >
            <div
              class="w-24 h-24 bg-white rounded-full flex items-center justify-center mb-2 shadow-family-profile"
            >
              <div class="w-20 h-20 rounded-full bg-white flex items-center justify-center">
                <span class="emoji-large text-green-500">+</span>
              </div>
            </div>
            <h3 class="text-base text-gray-800 font-medium">ë”ë³´ê¸°</h3>
            <p class="text-xs text-gray-600"></p>
          </div>
        </div>
      </section>

      <!-- Feature Cards Section - 3ì—´ ê·¸ë¦¬ë“œë¡œ ê°€ë¡œ ë°°ì¹˜ -->
      <section class="grid grid-cols-3 gap-4 mb-6">
        <!-- ì‹ë‹¨ ê¸°ë¡ ì¹´ë“œ -->
        <div
          class="card bg-base-100 shadow-sm hover:shadow-md transition-all duration-300 cursor-pointer h-full"
          @click="goToPage('meal')"
        >
          <div class="card-body items-center text-center p-5">
            <div class="mb-3 text-4xl">ğŸ½ï¸</div>
            <h2 class="text-lg font-bold text-gray-800 mb-1">ì‹ë‹¨ ê¸°ë¡</h2>
            <p class="text-sm text-gray-600">ì˜¤ëŠ˜ì˜ ì‹ì‚¬ë¥¼ ê¸°ë¡í•´ì£¼ì„¸ìš”</p>
          </div>
        </div>
        <!-- ë³µì•½ ì²´í¬ ì¹´ë“œ -->
        <div
          class="card bg-base-100 shadow-sm hover:shadow-md transition-all duration-300 cursor-pointer h-full"
          @click="goToPage('medication')"
        >
          <div class="card-body items-center text-center p-5">
            <div class="mb-3 text-4xl">ğŸ’Š</div>
            <h2 class="text-lg font-bold text-gray-800 mb-1">ë³µì•½ ì²´í¬</h2>
            <p class="text-sm text-gray-600">ì•½ ë³µìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”</p>
          </div>
        </div>
        <!-- ì£¼ê°„ ë¦¬í¬íŠ¸ ì¹´ë“œ -->
        <div
          class="card bg-base-100 shadow-sm hover:shadow-md transition-all duration-300 cursor-pointer h-full"
          @click="goToPage('report')"
        >
          <div class="card-body items-center text-center p-5">
            <div class="mb-3 text-4xl">ğŸ“Š</div>
            <h2 class="text-lg font-bold text-gray-800 mb-1">ì£¼ê°„ ë¦¬í¬íŠ¸</h2>
            <p class="text-sm text-gray-600">ì´ë²ˆ ì£¼ ê±´ê°• ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
          </div>
        </div>
      </section>

      <!-- Health Tips Section - í¬ê¸° ì¡°ì ˆ -->
      <section class="bg-brand-accent bg-opacity-30 rounded-lg p-5 shadow-sm">
        <div class="flex items-center mb-3">
          <span class="text-xl mr-2">â¤ï¸</span>
          <h2 class="text-lg font-bold text-brand-primary">ê±´ê°• íŒ</h2>
        </div>
        <div class="space-y-3">
          <div class="flex items-start">
            <span class="text-xl mr-2 mt-1">ğŸ</span>
            <p class="text-sm text-gray-700">
              ì‹ì‚¬ ì „ ë¬¼ì„ ì¶©ë¶„íˆ ë§ˆì‹œë©´ ì‹ìš•ì„ ì¡°ì ˆí•˜ëŠ” ë° ë„ì›€ì´ ë˜ë©°, í•˜ë£¨ì— ìµœì†Œ 8ì”ì˜ ë¬¼ì„
              ì„­ì·¨í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
            </p>
          </div>
          <div class="flex items-start">
            <span class="text-xl mr-2 mt-1">â°</span>
            <p class="text-sm text-gray-700">
              ì •í•´ì§„ ì‹œê°„ì— ì•½ì„ ë³µìš©í•˜ëŠ” ê²ƒì´ ì•½íš¨ë¥¼ ë†’ì´ëŠ” ë° ì¤‘ìš”í•˜ë©°, ê·œì¹™ì ì¸ ë³µìš© ìŠµê´€ì„
              ë“¤ì´ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
            </p>
          </div>
          <div class="flex items-start">
            <span class="text-xl mr-2 mt-1">ğŸš¶</span>
            <p class="text-sm text-gray-700">
              ìµœê·¼ ì¼êµì°¨ê°€ ì‹¬í•˜ë¯€ë¡œ ì™¸ì¶œ ì‹œ ì²´ì˜¨ ì¡°ì ˆì— ì‹ ê²½ ì“°ëŠ” ê²ƒì´ ê°ê¸° ì˜ˆë°©ì— ë„ì›€ì´ ë©ë‹ˆë‹¤.
            </p>
          </div>
        </div>
      </section>
    </main>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import UserService from '@/services/UserService'

const router = useRouter()
const allMembers = ref([])

// ë‚´ userId ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
const getMyUserId = () => {
  // ì²« ë²ˆì§¸ ì‹œë„: localStorageì—ì„œ 'userId' ì§ì ‘ ê°€ì ¸ì˜¤ê¸°
  const userIdStr = localStorage.getItem('userId')
  if (userIdStr && !isNaN(userIdStr)) {
    return Number(userIdStr)
  }

  // ë‘ ë²ˆì§¸ ì‹œë„: localStorageì—ì„œ 'user' ê°ì²´ì—ì„œ id ì¶”ì¶œ
  const userObjStr = localStorage.getItem('user')
  if (userObjStr) {
    try {
      const userObj = JSON.parse(userObjStr)
      if (userObj.id && !isNaN(userObj.id)) {
        return Number(userObj.id)
      }
    } catch (e) {
      console.error('ì‚¬ìš©ì ì •ë³´ íŒŒì‹± ì‹¤íŒ¨:', e)
    }
  }

  return null
}

const getMemberEmoji = (index) => {
  const emojis = ['ğŸ‘µ', 'ğŸ‘´', 'ğŸ‘©', 'ğŸ‘¨']
  return emojis[index % emojis.length]
}

// ê°€ì¡± í”„ë¡œí•„ í´ë¦­ ì‹œ: í•´ë‹¹ ë©¤ë²„ì˜ ì‹ë‹¨ìœ¼ë¡œ ì´ë™
const goToMealList = (memberId) => {
  console.log('ê°€ì¡± ë©¤ë²„ ì‹ë‹¨ìœ¼ë¡œ ì´ë™:', memberId)
  if (!memberId) {
    alert('ì˜ëª»ëœ ì‚¬ìš©ìì…ë‹ˆë‹¤')
    return
  }
  router.push(`/meals/${memberId}`)
}

// ë©”ì¸ ê¸°ëŠ¥ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
const goToPage = (page) => {
  console.log('í˜ì´ì§€ ì´ë™:', page)

  const myUserId = Number(getMyUserId())
  console.log('í˜„ì¬ ì‚¬ìš©ì ID:', myUserId)

  switch (page) {
    case 'meal':
      // userIdê°€ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ë¡œê·¸ì¸ìœ¼ë¡œ ë³´ëƒ„
      if (!myUserId || isNaN(myUserId) || myUserId <= 0) {
        alert('ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.')
        router.push('/login')
        return
      }
      console.log('ì‹ë‹¨ í˜ì´ì§€ë¡œ ì´ë™:', `/meals/${myUserId}`)
      router.push(`/meals/${myUserId}`)
      break
    case 'medication':
      console.log('ë³µì•½ í˜ì´ì§€ë¡œ ì´ë™')
      router.push('/medication')
      break
    case 'report':
      console.log('ë¦¬í¬íŠ¸ í˜ì´ì§€ë¡œ ì´ë™')
      router.push('/report')
      break
    default:
      console.warn('ì•Œ ìˆ˜ ì—†ëŠ” í˜ì´ì§€:', page)
      break
  }
}

const goToMyPage = () => {
  console.log('ë§ˆì´í˜ì´ì§€ë¡œ ì´ë™')
  router.push('/mypage')
}

// ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œ ê°€ì¡± ë©¤ë²„ ëª©ë¡ ë¡œë“œ
onMounted(async () => {
  console.log('ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ë¨')
  const myUserId = getMyUserId()
  console.log('ë‚´ userId:', myUserId)

  try {
    const { data } = await UserService.getAllGroupMembersOfMine()
    console.log('ê°€ì¡± ë©¤ë²„ ë°ì´í„°:', data)

    // ë‚´ ìì‹ ì€ ê°€ì¡± ëª©ë¡ì—ì„œ ì œì™¸
    allMembers.value = data.filter((member) => member.id !== myUserId)
    console.log('í•„í„°ë§ëœ ê°€ì¡± ë©¤ë²„:', allMembers.value)
  } catch (e) {
    console.error('ë©¤ë²„ ì¡°íšŒ ì‹¤íŒ¨:', e)
    // ì—ëŸ¬ ë°œìƒ ì‹œ ë¹ˆ ë°°ì—´ë¡œ ì„¤ì •
    allMembers.value = []
  }
})
</script>

<style scoped>
.emoji-large {
  font-size: 1.5rem;
  line-height: 1;
}
.scrollbar-hide::-webkit-scrollbar {
  display: none;
}
.scrollbar-hide {
  -ms-overflow-style: none;
  scrollbar-width: none;
}
.shadow-family-profile {
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}
.bg-brand-accent {
  background-color: #c7d7cb;
}
.bg-brand-lightbg {
  background-color: #f6faf7;
}
.text-brand-primary {
  color: #6a7d73;
}
.hover\:scale-105:hover {
  transform: scale(1.05);
  transition: transform 0.2s ease-in-out;
}
.hover\:shadow-md:hover {
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}
.transition-all {
  transition-property: all;
  transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
  transition-duration: 150ms;
}
.card-body {
  padding: 1.25rem;
}
.bg-base-100 {
  background-color: #ffffff;
}
.card {
  border-radius: 0.5rem;
  background-color: #ffffff;
  box-shadow:
    0 1px 3px 0 rgba(0, 0, 0, 0.1),
    0 1px 2px 0 rgba(0, 0, 0, 0.06);
}

@media (min-width: 768px) {
  main {
    max-width: 1280px;
  }
}
@media (max-width: 767px) {
  .grid-cols-3 {
    grid-template-columns: 1fr;
  }
}
::-webkit-scrollbar {
  height: 8px;
}
::-webkit-scrollbar-thumb {
  background: #b29888;
  border-radius: 8px;
}
</style>
