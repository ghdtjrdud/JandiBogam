<template>
  <div class="min-h-screen bg-gray-50 flex justify-center items-center py-8 px-4">
    <div class="w-full max-w-2xl bg-white rounded-lg shadow-md p-8">
      <!-- Logo and Header -->
      <div class="flex flex-col items-center mb-8">
        <img
          src="/src/assets/images/logo.png"
          alt="Dining Bom Logo"
          class="mx-auto mb-4 mt-2 w-44 h-auto"
        />
        <h1 class="text-[#6A7D73] text-xl font-bold text-center mb-1">íšŒì›ê°€ì…</h1>
        <p class="text-[#9E8C7F] text-center text-sm">ë‹¤ì´ë‹ë´„ê³¼ í•¨ê»˜ ê±´ê°•í•œ ì¼ìƒì„ ì‹œì‘í•˜ì„¸ìš”</p>
      </div>

      <!-- Signup Form -->
      <form @submit.prevent="handleSignup" class="space-y-6">
        <!-- Basic Information Section -->
        <div>
          <h3 class="text-[#6A7D73] font-medium mb-4">ê¸°ë³¸ ì •ë³´</h3>

          <div class="space-y-4">
            <!-- ID Field -->
            <div>
              <label for="id" class="block text-[#9E8C7F] text-sm mb-1">ì•„ì´ë””</label>
              <input
                id="id"
                v-model="signupForm.loginId"
                type="text"
                placeholder="6-12ìì˜ ì˜ë¬¸+ìˆ«ì"
                class="w-full rounded-md border border-[#D0B8A8] bg-white px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#9EB0A2]"
              />
            </div>

            <!-- Password Field -->
            <div>
              <label for="password" class="block text-[#9E8C7F] text-sm mb-1">ë¹„ë°€ë²ˆí˜¸</label>
              <input
                id="password"
                v-model="signupForm.password"
                type="password"
                placeholder="8ì ì´ìƒ, ì˜ë¬¸+ìˆ«ì+íŠ¹ìˆ˜ë¬¸ì"
                class="w-full rounded-md border border-[#D0B8A8] bg-white px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#9EB0A2]"
              />
            </div>

            <!-- Password Confirmation Field -->
            <div>
              <label for="passwordConfirm" class="block text-[#9E8C7F] text-sm mb-1"
                >ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label
              >
              <input
                id="passwordConfirm"
                v-model="signupForm.passwordConfirm"
                type="password"
                placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”"
                class="w-full rounded-md border border-[#D0B8A8] bg-white px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#9EB0A2]"
              />
            </div>

            <!-- Name Field -->
            <div>
              <label for="name" class="block text-[#9E8C7F] text-sm mb-1">ì´ë¦„</label>
              <input
                id="name"
                v-model="signupForm.name"
                type="text"
                placeholder="ì‹¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
                class="w-full rounded-md border border-[#D0B8A8] bg-white px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#9EB0A2]"
              />
            </div>

            <!-- Gender Selection -->
            <div>
              <label class="block text-[#9E8C7F] text-sm mb-2">ì„±ë³„</label>
              <div class="flex space-x-6">
                <label class="inline-flex items-center">
                  <input
                    type="radio"
                    v-model="signupForm.gender"
                    value="male"
                    class="radio radio-sm radio-primary"
                  />
                  <span class="ml-2 text-sm text-[#6A7D73]">ë‚¨ì„±</span>
                </label>
                <label class="inline-flex items-center">
                  <input
                    type="radio"
                    v-model="signupForm.gender"
                    value="female"
                    class="radio radio-sm radio-primary"
                  />
                  <span class="ml-2 text-sm text-[#6A7D73]">ì—¬ì„±</span>
                </label>
              </div>
            </div>

            <!-- ìƒë…„ì›”ì¼ (ë‹¬ë ¥) -->
            <div>
              <label class="block text-[#9E8C7F] text-lg font-semibold mb-3">ìƒë…„ì›”ì¼</label>
              <VueDatePicker
                v-model="signupForm.birthdate"
                :format="'yyyy-MM-dd'"
                placeholder="ìƒë…„ì›”ì¼ì„ ì„ íƒí•˜ì„¸ìš”"
                :enable-time-picker="false"
                :max-date="new Date()"
                input-class-name="w-full rounded-xl border border-[#B29888] bg-[#F6FAF7] px-6 py-4 text-lg focus:outline-none focus:ring-2 focus:ring-[#6A7D73]"
              />
            </div>

            <!-- Family Code -->
            <div>
              <label for="familyCode" class="block text-[#9E8C7F] text-sm mb-1"
                >ê°€ì¡±ì½”ë“œ (ì„ íƒì‚¬í•­)</label
              >
              <input
                id="familyCode"
                v-model="signupForm.familyCode"
                type="text"
                placeholder="ê³µìœ ë°›ì€ ê°€ì¡±ì½”ë“œê°€ ìˆë‹¤ë©´ ì…ë ¥í•˜ì„¸ìš”"
                class="w-full rounded-md border border-[#D0B8A8] bg-white px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#9EB0A2]"
              />
              <p class="text-xs text-[#9E8C7F] mt-1">* ê°€ì¡±ì½”ë“œê°€ ì—†ì–´ë„ íšŒì›ê°€ì…ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤</p>
            </div>
          </div>
        </div>

        <!-- Health Information Section -->
        <div>
          <h3 class="text-[#6A7D73] font-medium mb-4">ê±´ê°• ì •ë³´</h3>

          <div class="grid grid-cols-2 gap-3">
            <label class="inline-flex items-center">
              <input
                type="checkbox"
                v-model="signupForm.healthInfo.diabetes"
                class="checkbox checkbox-sm checkbox-primary"
              />
              <span class="ml-2 text-sm text-[#6A7D73]">ë‹¹ë‡¨</span>
            </label>

            <label class="inline-flex items-center">
              <input
                type="checkbox"
                v-model="signupForm.healthInfo.hypertension"
                class="checkbox checkbox-sm checkbox-primary"
              />
              <span class="ml-2 text-sm text-[#6A7D73]">ê³ í˜ˆì••</span>
            </label>

            <label class="inline-flex items-center">
              <input
                type="checkbox"
                v-model="signupForm.healthInfo.heartDisease"
                class="checkbox checkbox-sm checkbox-primary"
              />
              <span class="ml-2 text-sm text-[#6A7D73]">ì‹¬ì¥ì§ˆí™˜</span>
            </label>

            <label class="inline-flex items-center">
              <input
                type="checkbox"
                v-model="signupForm.healthInfo.kidneyDisease"
                class="checkbox checkbox-sm checkbox-primary"
              />
              <span class="ml-2 text-sm text-[#6A7D73]">ì‹ ì¥ì§ˆí™˜</span>
            </label>

            <label class="inline-flex items-center">
              <input
                type="checkbox"
                v-model="signupForm.healthInfo.liverDisease"
                class="checkbox checkbox-sm checkbox-primary"
              />
              <span class="ml-2 text-sm text-[#6A7D73]">ê°„ì§ˆí™˜</span>
            </label>
          </div>
        </div>

        <!-- Submit Button -->
        <button
          type="submit"
          class="w-full py-3 rounded-md bg-[#6A9B5E] text-white text-base font-medium hover:bg-[#5A8B4E] transition-colors"
        >
          íšŒì›ê°€ì… ì™„ë£Œ
        </button>
      </form>

      <!-- Return to Login Link -->
      <div class="text-center mt-6">
        <router-link to="/login" class="text-[#9EB0A2] hover:text-[#6A7D73] text-sm">
          ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        </router-link>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, reactive, computed } from 'vue'
import { useRouter } from 'vue-router'
import { useToast } from 'vue-toastification'
import VueDatePicker from '@vuepic/vue-datepicker'
import '@vuepic/vue-datepicker/dist/main.css'
import { useAuthStore } from '@/stores/auth'

const router = useRouter()
const toast = useToast()
const authStore = useAuthStore()

const signupForm = reactive({
  loginId: '', // ì—¬ê¸° loginIdë¡œ!
  password: '',
  passwordConfirm: '',
  name: '',
  gender: '',
  birthdate: '',
  familyCode: '',
  healthInfo: {
    diabetes: false,
    hypertension: false, // â† key ì´ë¦„ ë°˜ë“œì‹œ DTOì™€ ë§ì¶°ì•¼!
    heartDisease: false,
    kidneyDisease: false,
    liverDisease: false,
  },
})

// ìœ íš¨ì„± ê²€ì‚¬ ì˜¤ë¥˜ ë©”ì‹œì§€
const errors = reactive({
  id: '',
  password: '',
  passwordConfirm: '',
  name: '',
  birthdate: '',
})

// ê³„ì‚°ëœ ì†ì„±: í¼ ìœ íš¨ì„± ì—¬ë¶€
const isFormValid = computed(() => {
  return (
    !errors.id &&
    !errors.password &&
    !errors.passwordConfirm &&
    !errors.name &&
    !errors.birthdate &&
    signupForm.loginId &&
    signupForm.password &&
    signupForm.name &&
    signupForm.gender &&
    signupForm.birthdate
  )
})

// ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜
const validateForm = () => {
  let isValid = true

  // ID ìœ íš¨ì„± ê²€ì‚¬
  if (!signupForm.loginId.match(/^[a-zA-Z0-9]{6,12}$/)) {
    errors.id = '6-12ì ì˜ë¬¸/ìˆ«ì ì¡°í•©ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”'
    isValid = false
  } else {
    errors.id = ''
  }

  // ë¹„ë°€ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬
  const passwordRegex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,}$/
  if (!passwordRegex.test(signupForm.password)) {
    errors.password = 'ì˜ë¬¸+ìˆ«ì+íŠ¹ìˆ˜ë¬¸ì 8ì ì´ìƒ í•„ìš”'
    isValid = false
  } else {
    errors.password = ''
  }

  // ë¹„ë°€ë²ˆí˜¸ í™•ì¸
  if (signupForm.password !== signupForm.passwordConfirm) {
    errors.passwordConfirm = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤'
    isValid = false
  } else {
    errors.passwordConfirm = ''
  }

  // ì´ë¦„ í™•ì¸
  if (!signupForm.name) {
    errors.name = 'ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'
    isValid = false
  } else {
    errors.name = ''
  }

  // ìƒë…„ì›”ì¼ í•„ìˆ˜ í™•ì¸
  if (!signupForm.birthdate) {
    errors.birthdate = 'ìƒë…„ì›”ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”'
    isValid = false
  } else {
    errors.birthdate = ''
  }

  return isValid
}

// íšŒì›ê°€ì… ì²˜ë¦¬
const handleSignup = async () => {
  if (!validateForm()) return

  try {
    // ì„œë²„ì— ì „ì†¡í•  ë°ì´í„° ì¤€ë¹„ - ë°±ì—”ë“œ SignupRequest í˜•ì‹ì— ë§ê²Œ ìˆ˜ì •
    const userData = {
      // ë°±ì—”ë“œ ì»¨íŠ¸ë¡¤ëŸ¬ì˜ SignupRequest DTOì— ë§ëŠ” í•„ë“œëª… ì‚¬ìš©
      loginId: signupForm.loginId, // ì•„ì´ë”” í•„ë“œëª… ë³€ê²½
      password: signupForm.password,
      name: signupForm.name,
      gender: signupForm.gender === 'male' ? 'M' : 'F',
      // ISO í˜•ì‹(YYYY-MM-DD)ìœ¼ë¡œ ë‚ ì§œ ë³€í™˜
      birthDate:
        signupForm.birthdate instanceof Date
          ? signupForm.birthdate.toISOString().split('T')[0]
          : signupForm.birthdate,
      // ì„ íƒì  í•„ë“œ
      familyCode: signupForm.familyCode || null,
      // ğŸ‘‡ ê±´ê°• ì •ë³´: ê°ì²´ í•„ë“œë¥¼ ê·¸ëŒ€ë¡œ userDataì— í¬í•¨
      diabetes: signupForm.healthInfo.diabetes,
      hypertension: signupForm.healthInfo.hypertension,
      heartDisease: signupForm.healthInfo.heartDisease,
      kidneyDisease: signupForm.healthInfo.kidneyDisease,
      liverDisease: signupForm.healthInfo.liverDisease,
    }

    // const plainUserData = JSON.parse(JSON.stringify(userData))

    console.log('signupForm.healthInfo:', signupForm.healthInfo)
    console.log('userData:', userData)

    // Pinia ìŠ¤í† ì–´ì˜ register ì•¡ì…˜ í˜¸ì¶œ
    const success = await authStore.register(userData)

    if (success) {
      toast.success('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!')
      router.push('/login') // íšŒì›ê°€ì… í›„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
    } else {
      // authStore.error ë˜ëŠ” authStore.getError()ë¥¼ ì‚¬ìš© (ìŠ¤í† ì–´ êµ¬í˜„ì— ë”°ë¼ ë‹¤ë¦„)
      toast.error(authStore.error || 'íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤')
    }
  } catch (error) {
    console.error('íšŒì›ê°€ì… ì—ëŸ¬:', error)
    toast.error('íšŒì›ê°€ì… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤')
  }
}
</script>
